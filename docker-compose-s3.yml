# UsersConnect with S3 Image Uploads
# This file contains examples for different S3 providers
# Uncomment the provider you want to use

version: '3.8'

services:
  app:
    image: omairsalman/usersconnect:latest
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      # Generate secrets with: openssl rand -hex 32
      - ACCESS_TOKEN_SECRET=change-this-to-random-secret-min-32-chars
      - REFRESH_TOKEN_SECRET=change-this-to-random-secret-min-32-chars
      - DATABASE_HOST=mysql
      - DATABASE_USERNAME=root
      - DATABASE_PASSWORD=yourpassword
      - DATABASE_NAME=usersconnect
      - REDIS_HOST=redis
      - REDIS_PASSWORD=

      # ===========================================
      # S3 CONFIGURATION - Choose One Provider
      # ===========================================

      # OPTION 1: AWS S3 (Cloud)
      # Uncomment these 4 lines for AWS S3:
      # - S3_ACCESS_KEY=AKIA...
      # - S3_SECRET_KEY=wJal...
      # - S3_BUCKET_NAME=usersconnect-media
      # - S3_REGION=us-east-1
      
      # OPTION 2: MinIO (Self-Hosted)
      # Uncomment these 5 lines for MinIO:
      # - S3_ACCESS_KEY=minioadmin
      # - S3_SECRET_KEY=minioadmin
      # - S3_BUCKET_NAME=usersconnect-media
      # - S3_REGION=us-east-1
      # - S3_ENDPOINT=http://minio:9000

      # OPTION 3: DigitalOcean Spaces
      # Uncomment these 5 lines for DigitalOcean Spaces:
      # - S3_ACCESS_KEY=your-do-spaces-key
      # - S3_SECRET_KEY=your-do-spaces-secret
      # - S3_BUCKET_NAME=usersconnect-media
      # - S3_REGION=nyc3
      # - S3_ENDPOINT=https://nyc3.digitaloceanspaces.com

      # OPTION 4: Cloudflare R2
      # Uncomment these 5 lines for Cloudflare R2:
      # - S3_ACCESS_KEY=your-r2-access-key
      # - S3_SECRET_KEY=your-r2-secret-key
      # - S3_BUCKET_NAME=usersconnect-media
      # - S3_REGION=auto
      # - S3_ENDPOINT=https://your-account-id.r2.cloudflarestorage.com

    depends_on:
      - mysql
      - redis
      # Uncomment this if using MinIO:
      # - minio
    restart: unless-stopped

  mysql:
    image: mysql:8
    environment:
      - MYSQL_ROOT_PASSWORD=yourpassword
      - MYSQL_DATABASE=usersconnect
    volumes:
      - mysql_data:/var/lib/mysql
    restart: unless-stopped

  redis:
    image: redis:alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: unless-stopped

  # ===========================================
  # MINIO SETUP (OPTION 2 ONLY)
  # Uncomment these services if using MinIO
  # ===========================================

  # minio:
  #   image: minio/minio:latest
  #   ports:
  #     - "9000:9000"
  #     - "9001:9001"
  #   environment:
  #     MINIO_ROOT_USER: minioadmin
  #     MINIO_ROOT_PASSWORD: minioadmin
  #   volumes:
  #     - minio_data:/data
  #   command: server /data --console-address ":9001"
  #   restart: unless-stopped

  # minio-setup:
  #   image: minio/mc:latest
  #   depends_on:
  #     - minio
  #   entrypoint: >
  #     /bin/sh -c "
  #     sleep 5;
  #     mc alias set myminio http://minio:9000 minioadmin minioadmin;
  #     mc mb myminio/usersconnect-media --ignore-existing;
  #     mc anonymous set download myminio/usersconnect-media;
  #     exit 0;
  #     "

volumes:
  mysql_data:
  redis_data:
  # Uncomment this if using MinIO:
  # minio_data:

# ===========================================
# USAGE INSTRUCTIONS
# ===========================================
#
# 1. Choose ONE S3 provider from the options above
# 2. Uncomment the corresponding environment variables
# 3. If using MinIO, also uncomment the minio services and volume
# 4. Replace placeholder values with your actual credentials
# 5. Generate JWT secrets: openssl rand -hex 32
# 6. Run: docker-compose -f docker-compose-s3.yml up -d
#
# ===========================================
# PROVIDER COMPARISON
# ===========================================
#
# AWS S3:
#   - Most popular, reliable
#   - Free tier: 5GB storage, 20k GET, 2k PUT
#   - After free tier: ~$0.023/GB/month
#   - Setup: Create bucket + IAM user (see GitHub README)
#
# MinIO:
#   - 100% free, open source
#   - Self-hosted (uses your server resources)
#   - S3-compatible API
#   - Best for: Development, self-hosting
#   - Console: http://localhost:9001
#
# DigitalOcean Spaces:
#   - $5/month for 250GB
#   - Simple pricing
#   - S3-compatible
#
# Cloudflare R2:
#   - No egress fees
#   - $0.015/GB/month
#   - S3-compatible
#
# ===========================================
