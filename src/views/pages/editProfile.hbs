<div class="edit-profile-card">
  <!-- Back to Profile Button -->
  <a href="/profile" class="btn btn-link mb-3 p-0">
    <i class="fa-solid fa-arrow-left"></i> Back to Profile
  </a>

  <h1>Edit Profile</h1>

  <!-- Hidden form for userId AND email -->
  <form id="edit-profile-form" data-userid="{{currentUser._id}}" data-useremail="{{currentUser.email}}" style="display:none;"></form>

  <!-- Avatar Section -->
  <div class="form-group mb-4">
    <label class="form-label fw-semibold">Profile Picture</label>
    <div class="d-flex align-items-center mb-3">
      <img 
        id="current-avatar"
        src="{{currentUser.avatarURL}}" 
        alt="{{currentUser.name}}'s avatar" 
        class="edit-avatar-img me-3"
        style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;"
      >
      <div>
        {{#if s3Enabled}}
          <button type="button" id="remove-custom-picture-btn" class="btn btn-sm btn-danger mb-2" style="display: none;">
            <i class="fa-solid fa-times"></i> Remove Custom Picture
          </button>
          <div>
            <label for="profile-picture-input" class="btn btn-sm btn-outline-primary mb-0">
              <i class="fa-solid fa-upload"></i> Upload New Picture
            </label>
            <input 
              type="file" 
              id="profile-picture-input" 
              accept="image/*" 
              style="display: none;">
            <small class="form-text text-muted d-block mt-1">Max size: 5MB. Supported: JPG, PNG, GIF</small>
          </div>
        {{else}}
          <a href="https://gravatar.com" target="_blank" class="btn btn-link">Change avatar on Gravatar</a>
        {{/if}}
      </div>
    </div>

    {{#if s3Enabled}}
      <!-- Preview Section -->
      <div id="profile-picture-preview" style="display: none;">
        <div class="card p-3 mb-3">
          <label class="form-label small fw-semibold">Preview:</label>
          <div class="d-flex align-items-center gap-3">
            <img 
              id="preview-avatar" 
              src="" 
              alt="Preview" 
              style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">
            <div>
              <button type="button" id="save-profile-picture-btn" class="btn btn-sm btn-primary me-2">
                <i class="fa-solid fa-check"></i> Save Picture
              </button>
              <button type="button" id="cancel-profile-picture-btn" class="btn btn-sm btn-secondary">
                <i class="fa-solid fa-times"></i> Cancel
              </button>
            </div>
          </div>
        </div>
      </div>

      <small class="form-text text-muted">
        Don't have a custom picture? <a href="https://gravatar.com" target="_blank">Change avatar on Gravatar â†—</a>
      </small>
    {{/if}}
  </div>

  <hr class="my-4">

  <!-- Name Section -->
  <div class="form-group mb-4">
    <label for="edit-name" class="form-label fw-semibold">Name</label>
    <div class="input-group">
      <input type="text" id="edit-name" name="name" value="{{currentUser.name}}" class="form-control" required data-original="{{currentUser.name}}">
      <button type="button" id="update-name-btn" class="btn btn-primary" disabled>
        <i class="fa-solid fa-check"></i> Update Name
      </button>
    </div>
  </div>

  <hr class="my-4">

  <!-- Email Section -->
  <div class="form-group mb-4">
    <label class="form-label fw-semibold">
      Email Address
      {{#unless currentUser.isEmailVerified}}
        <span class="text-danger">- Unverified</span>
      {{/unless}}
    </label>
    <div class="d-flex align-items-center gap-2 mb-2">
      <span id="user-email-display" class="text-muted">{{currentUser.email}}</span>
      
      {{#unless currentUser.isEmailVerified}}
        <button type="button" class="btn btn-sm btn-success" onclick="window.openVerifyEmailModal()">
          <i class="fa-solid fa-envelope-circle-check"></i> Verify Email
        </button>
      {{/unless}}
      
      {{#if currentUser.isEmailVerified}}
        <button type="button" id="change-email-btn" class="btn btn-sm btn-outline-primary">
          <i class="fa-solid fa-pen"></i> Change Email
        </button>
      {{/if}}
    </div>

    <!-- Email Privacy -->
    <div class="form-check">
      <input 
        type="checkbox" 
        class="form-check-input" 
        id="isEmailPublic" 
        name="isEmailPublic" 
        {{#if currentUser.isEmailPublic}}checked{{/if}} 
        {{#unless currentUser.isEmailVerified}}disabled{{/unless}}
        data-original="{{currentUser.isEmailPublic}}">
      <label class="form-check-label {{#unless currentUser.isEmailVerified}}text-muted{{/unless}}" for="isEmailPublic">
        Make my email visible on my profile
        {{#unless currentUser.isEmailVerified}}
          <i class="fa-solid fa-lock ms-1" title="Verify your email to enable this option"></i>
        {{/unless}}
      </label>
      <button type="button" id="update-email-privacy-btn" class="btn btn-sm btn-primary ms-2" style="display: none;">
        <i class="fa-solid fa-check"></i> Save
      </button>
    </div>
    {{#if currentUser.isEmailVerified}}
      <small class="form-text text-muted">When unchecked, only you can see your email address.</small>
    {{else}}
      <small class="form-text text-warning">
        <i class="fa-solid fa-exclamation-triangle"></i> Verify your email address to control email visibility.
      </small>
    {{/if}}
  </div>

  <hr class="my-4">

  <!-- Password Section -->
  <div class="form-group mb-4">
    <label class="form-label fw-semibold">Change Password</label>
    
    <div class="mb-3">
      <label for="current-password" class="form-label">Current Password</label>
      <input type="password" id="current-password" name="currentPassword" class="form-control" placeholder="Required to change password">
    </div>

    <div class="mb-3">
      <label for="new-password" class="form-label">New Password</label>
      <input type="password" id="new-password" name="newPassword" class="form-control" placeholder="At least 6 characters">
    </div>

    <div class="mb-3">
      <label for="confirm-password" class="form-label">Confirm New Password</label>
      <input type="password" id="confirm-password" name="confirmPassword" class="form-control" placeholder="Re-enter your new password">
    </div>

    <small id="password-error" class="form-text text-danger d-block mb-2" style="display: none;"></small>

    <button type="button" id="update-password-btn" class="btn btn-primary">
      <i class="fa-solid fa-key"></i> Update Password
    </button>
  </div>
</div>

<script src="/js/edit-profile.js"></script>