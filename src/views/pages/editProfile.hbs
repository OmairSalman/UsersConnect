<div class="edit-profile-card">
  <h1>Edit Profile</h1>
  <form id="edit-profile-form" method="POST" action="/users/{{currentUser._id}}" autocomplete="off" data-userid="{{currentUser._id}}">
    <!-- Avatar Section -->
    <div class="form-group mb-4">
      <label class="form-label fw-semibold">Profile Picture</label>
      <div class="d-flex align-items-center mb-3">
      <img 
        id="current-avatar"
        src="{{currentUser.avatarURL}}" 
        alt="{{currentUser.name}}'s avatar" 
        class="edit-avatar-img me-3"
        style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;"
      >
      <div>
        {{#if s3Enabled}}
          <button type="button" id="remove-custom-picture-btn" class="btn btn-sm btn-danger mb-2" style="display: none;">
            <i class="fa-solid fa-times"></i> Remove Custom Picture
          </button>
          <div>
            <label for="profile-picture-input" class="btn btn-sm btn-outline-primary mb-0">
              <i class="fa-solid fa-upload"></i> Upload New Picture
            </label>
            <input 
              type="file" 
              id="profile-picture-input" 
              accept="image/*" 
              style="display: none;">
            <small class="form-text text-muted d-block mt-1">Max size: 5MB. Supported: JPG, PNG, GIF</small>
          </div>
        {{else}}
          <a href="https://gravatar.com" target="_blank" class="btn btn-link">Change avatar on Gravatar</a>
        {{/if}}
      </div>
    </div>

    {{#if s3Enabled}}
      <!-- Preview Section (hidden by default) -->
      <div id="profile-picture-preview" style="display: none;">
        <div class="card p-3 mb-3">
          <label class="form-label small fw-semibold">Preview:</label>
          <div class="d-flex align-items-center gap-3">
            <img 
              id="preview-avatar" 
              src="" 
              alt="Preview" 
              style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">
            <div>
              <button type="button" id="save-profile-picture-btn" class="btn btn-sm btn-primary me-2">
                <i class="fa-solid fa-check"></i> Save Picture
              </button>
              <button type="button" id="cancel-profile-picture-btn" class="btn btn-sm btn-secondary">
                <i class="fa-solid fa-times"></i> Cancel
              </button>
            </div>
          </div>
        </div>
      </div>

      <small class="form-text text-muted">
        Don't have a custom picture? <a href="https://gravatar.com" target="_blank">Change avatar on Gravatar â†—</a>
      </small>
    {{/if}}

    <hr class="my-4">

    <!-- Name -->
    <div class="form-group mb-3">
      <label for="edit-name">Name</label>
      <input type="text" id="edit-name" name="name" value="{{currentUser.name}}" class="form-control" required>
    </div>

    <div class="form-group mb-3">
      <div class="form-check">
        <input type="checkbox" class="form-check-input" id="isEmailPublic" name="isEmailPublic" {{#if currentUser.isEmailPublic}}checked{{/if}}>
        <label class="form-check-label" for="isEmailPublic">
          Make my email visible on my profile
        </label>
      </div>
      <small class="form-text text-muted">When unchecked, only you can see your email address.</small>
    </div>

    <!-- Section: Sensitive info (locked by password) -->
    <div class="form-group mb-3">
      <label for="current-password">Enter your current password to edit email or password</label>
      <div class="d-flex">
        <input type="password" id="current-password" name="currentPassword" class="form-control me-2">
        <button type="button" id="verify-password-btn" class="btn btn-secondary">Verify</button>
      </div>
      <small id="verify-password-msg" class="form-text"></small>
    </div>

    <fieldset id="sensitive-fields" disabled>
      <!-- Email -->
      <div class="form-group mb-3">
        <label for="edit-email">Email</label>
        <input type="email" id="edit-email" name="email" value="{{currentUser.email}}" class="form-control">
        {{#unless hasCustomAvatar}}
        <small id="email-msg" class="form-text text-muted">
          Changing your email will update your avatar to the Gravatar for the new email (or a random image if that email has no Gravatar).
        </small>
        {{/unless}}
      </div>

      <!-- New Password -->
      <div class="form-group mb-3">
        <label for="new-password">New Password</label>
        <input type="password" id="new-password" name="newPassword" class="form-control">
      </div>
      <div class="form-group mb-3">
        <label for="confirm-password">Confirm New Password</label>
        <input type="password" id="confirm-password" name="confirmPassword" class="form-control">
        <small id="password-warning" class="form-text text-danger"></small>
      </div>
    </fieldset>

    <button type="submit" class="btn btn-primary mt-2">Save Changes</button>
    <a href="/profile" class="btn btn-link mt-2">Cancel</a>
  </form>
</div>

<script src="/js/edit-profile.js"></script>